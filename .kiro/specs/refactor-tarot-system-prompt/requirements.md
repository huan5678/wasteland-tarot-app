# 需求文件：廢土塔羅 AI System Prompt 重構

## 專案概述

將 AI 解牌系統從「神秘占卜」升級為「深度心理投射工具」，結合榮格深度心理學、敘事治療方法，並深度整合 Fallout 廢土世界觀。

## 使用者故事

### US-1：心理學深度使用者
**身份**：尋求自我探索的用戶
**需求**：我希望塔羅解讀不只是預測，而是幫助我理解自己的內在狀態
**價值**：獲得基於心理學的深刻洞察，而非模糊的神秘主義

**接受標準**：
- 解讀使用榮格原型理論（英雄、陰影、智者等）
- 明確避免預測性語言（「你將會...」）
- 使用投射技術幫助用戶外化內在衝突

### US-2：Fallout 粉絲
**身份**：熱愛 Fallout 世界觀的玩家
**需求**：我希望塔羅解讀深度融入廢土設定，而非表面化的引用
**價值**：獲得沉浸式體驗，廢土元素成為心理隱喻系統

**接受標準**：
- 輻射作為創傷能量的隱喻
- 變種生物作為陰影原型
- 陣營系統作為價值觀探索
- 業力系統作為道德取向反映

### US-3：不同角色風格愛好者
**身份**：喜歡體驗不同角色視角的用戶
**需求**：我希望每個角色不只是語言風格不同，而是有獨特的心理學詮釋方法
**價值**：透過不同角色獲得多元視角，發現不同洞察

**接受標準**：
- Pip-Boy：數據化理性分析 + 榮格原型
- Vault Dweller：成長故事 + 英雄旅程
- Wasteland Trader：實用主義 + 交易隱喻
- Codsworth：家庭化關懷 + 溫柔界限
- Super Mutant：存在主義 + 極簡真相
- Ghoul：創傷共鳴 + 時間智慧

### US-4：心理安全需求者
**身份**：可能處於情緒困擾的用戶
**需求**：我希望系統能識別危機並提供適當資源
**價值**：獲得安全的探索空間，在需要時得到專業引導

**接受標準**：
- 自動識別自殺/自傷意念
- 提供台灣危機專線（1925, 1995, 1980）
- 明確 AI 限制聲明（無法替代專業諮商）
- 使用創傷知情語言

## 功能性需求

### FR-1：資料庫驅動的 Prompt 系統
**EARS 需求**：
- **Event**: 當系統需要生成解讀時
- **Activity**: 系統從資料庫 `characters` 表讀取 `ai_system_prompt`
- **Result**: 載入完整的角色專屬 System Prompt（3000-4500字）

**接受標準**：
- [ ] `characters.ai_system_prompt` 欄位儲存完整 prompt
- [ ] `characters.ai_tone_description` 儲存語調描述
- [ ] `characters.ai_prompt_config` 儲存 JSON 配置
- [ ] 所有 6 個角色都有完整 prompt

### FR-2：心理學框架整合
**EARS 需求**：
- **Event**: 當 AI 生成解讀時
- **Activity**: 系統遵循 5 階段解讀流程
- **Result**: 產出包含心理學深度的解讀（而非簡單牌義說明）

**接受標準**：
- [ ] 階段 1：廢土場景建構（投射空間）
- [ ] 階段 2：投射性提問（引導用戶連結）
- [ ] 階段 3：原型與陰影探索（榮格框架）
- [ ] 階段 4：敘事重構（限制性 → 可能性）
- [ ] 階段 5：行動賦權（強調選擇權）

### FR-3：角色差異化系統
**EARS 需求**：
- **Event**: 當用戶選擇不同角色時
- **Activity**: 系統使用該角色的專屬 prompt 和風格配置
- **Result**: 解讀呈現該角色獨特的心理學詮釋方式

**接受標準**：
- [ ] 每個角色有獨立的 system prompt（3000-4500字）
- [ ] Pip-Boy 使用數據化語言 + 系統化建議
- [ ] Vault Dweller 使用故事性敘事 + 成長框架
- [ ] Wasteland Trader 使用交易化語言 + 實用主義
- [ ] Codsworth 使用家庭化關懷 + 英式禮儀
- [ ] Super Mutant 使用極簡語言 + 直接真相
- [ ] Ghoul 使用時間視角 + 創傷共鳴

### FR-4：廢土隱喻系統
**EARS 需求**：
- **Event**: 當解讀需要使用廢土元素時
- **Activity**: 系統將廢土元素作為心理學隱喻（而非單純裝飾）
- **Result**: 產出深度整合廢土世界觀的心理洞察

**接受標準**：
- [ ] 輻射 = 創傷能量（輻射劑量 = 強度、輻消劑 = 療癒資源）
- [ ] 變種生物 = 陰影原型（屍鬼 = 被創傷改變、超級變種人 = 力量扭曲）
- [ ] 避難所 = 防禦機制（離開避難所 = 英雄旅程）
- [ ] 業力系統 = 當前道德取向（而非絕對標籤）
- [ ] 陣營 = 價值觀系統（鋼鐵兄弟會 = 秩序、NCR = 民主理想等）

### FR-5：倫理保障機制
**EARS 需求**：
- **Event**: 當解讀涉及痛苦主題或危機訊號時
- **Activity**: 系統執行危機處理協議
- **Result**: 提供適當警示、資源和專業引導

**接受標準**：
- [ ] 識別自殺/自傷意念關鍵詞
- [ ] 自動提供台灣危機專線（1925, 1995, 1980）
- [ ] 每次解讀後附加 AI 限制聲明
- [ ] 避免預測性語言（「你將會...」、「註定...」）
- [ ] 使用賦權語言（「你可以選擇...」、「決策權在你手中」）
- [ ] 溫和處理創傷主題

## 非功能性需求

### NFR-1：Prompt 字數規範
- Pip-Boy：250-300 字
- Vault Dweller：280-320 字
- Wasteland Trader：240-280 字
- Codsworth：270-310 字
- Super Mutant：200-240 字
- Ghoul：280-320 字

### NFR-2：語言要求
- 所有解讀必須使用繁體中文（zh-TW）
- 台灣用語和文化語境
- 廢土專有名詞可保留英文並附註中文

### NFR-3：回應時間
- AI 生成時間：2-5 秒
- 資料庫查詢時間：< 100ms
- 總體回應時間：< 6 秒

### NFR-4：成本控制
- 每次解讀成本：$0.01-0.03（依 AI 提供商）
- Prompt Token：1500-2000 tokens
- Completion Token：300-500 tokens

## 技術約束

### TC-1：資料庫架構
- 使用現有 `characters` 表
- 欄位：`ai_system_prompt` (Text), `ai_tone_description` (String), `ai_prompt_config` (JSON)
- 無需新建資料表

### TC-2：AI Provider 整合
- 支援現有的多提供商架構（OpenAI, Gemini, Anthropic）
- 使用現有 `AIInterpretationService` 類別
- 透過 `_get_character_prompt()` 方法從資料庫載入 prompt

### TC-3：向後相容
- 保留現有 API 端點
- 如果 `ai_system_prompt` 為空，使用 fallback 靜態解讀
- 不破壞現有前端整合

## 測試需求

### TR-1：單元測試
- [ ] 測試每個角色的語言風格一致性
- [ ] 驗證 prompt 中不含預測性語言
- [ ] 檢查字數限制符合規範

### TR-2：整合測試
- [ ] 測試完整解讀流程
- [ ] 驗證資料庫配置正確載入
- [ ] 測試 AI Provider 調用成功

### TR-3：人工評測
- [ ] 測試 5 張不同類型的牌（The Fool, The Tower, The Devil, Death, Ten of Swords）
- [ ] 所有 6 個角色
- [ ] 評分標準：角色一致性、心理學深度、非預測性、廢土整合、賦權語言、字數控制

## 部署策略

### DS-1：漸進式部署
- Phase 1：A/B 測試（50% 用戶使用新 prompt，2 週）
- Phase 2：漸進切換（50% → 70% → 90%，2 週）
- Phase 3：完全遷移（1 週）

### DS-2：監控指標
- 用戶解讀完成率 ≥ 85%
- 平均停留時間增加 ≥ 20%
- 重複使用率 ≥ 40%
- AI 服務可用性 ≥ 99%

### DS-3：回滾計畫
- 保留資料庫備份
- 程式碼層級降級開關（`USE_NEW_PROMPTS` flag）
- 保留舊版 fallback 機制

## 風險評估

| 風險 | 可能性 | 影響 | 應對措施 |
|------|-------|------|----------|
| AI 成本超支 | 中 | 中 | 設定 token 限制、使用 cache、監控每日成本 |
| 解讀質量不穩定 | 中 | 高 | 實施質量驗證、fallback 機制、人工抽查 |
| 用戶不適應新風格 | 低 | 中 | A/B 測試、漸進式部署、收集回饋 |
| 法律/倫理問題 | 低 | 高 | 明確 AI 限制聲明、提供危機資源、合規審查 |

## 成功標準

### 量化指標
- [ ] 用戶解讀完成率 ≥ 85%
- [ ] 平均停留時間增加 ≥ 20%
- [ ] 重複使用率 ≥ 40%

### 質化指標
- [ ] 用戶回饋提到「深刻」、「有幫助」、「準確」
- [ ] 內部評測評分 ≥ 4.0/5.0
- [ ] 無「太預測性」或「不尊重」的投訴

## 參考資料

### 學術基礎
- 榮格《紅書》與原型理論
- Michael White《敘事治療的實踐》
- Rachel Pollack《塔羅的七十八度智慧》

### 遊戲世界觀
- Fallout 系列遊戲設定集
- Fallout Bible（官方背景設定）

### 倫理指引
- 台灣心理諮商倫理守則
- APA 心理學家倫理規範

---

**版本**：v1.0
**最後更新**：2025-01-23
**狀態**：已批准，進入設計階段
