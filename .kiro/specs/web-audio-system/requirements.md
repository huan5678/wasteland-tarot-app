# 需求文件 - Web Audio System

## 簡介

本規格定義 Wasteland Tarot 平台的音效系統需求，使用 Web Audio API 實現沉浸式的 Fallout 主題音效體驗。系統將提供音效播放、語音合成、背景音樂管理和音量控制功能，以增強使用者的廢土占卜體驗。

### 業務價值
- **提升沉浸感**：透過 Pip-Boy 音效、蓋革計數器聲和 Vault 音效增強 Fallout 主題體驗
- **改善使用者體驗**：透過音訊回饋提供更直觀的互動反應
- **支援無障礙功能**：語音合成（TTS）支援視覺障礙使用者
- **效能優化**：音效快取和預載確保流暢的使用者體驗

## 需求

### 需求 1：音效播放系統
**使用者故事**：作為一個廢土旅者，我希望在與平台互動時聽到 Fallout 主題音效，以獲得更沉浸式的體驗

#### 驗收標準

1. WHEN 使用者點擊按鈕或互動元素 THEN 系統 SHALL 播放對應的 Pip-Boy 音效（點擊聲、確認聲）
2. WHEN 頁面載入完成 THEN 系統 SHALL 播放 Vault 門開啟音效
3. WHEN 抽取塔羅牌時 THEN 系統 SHALL 播放卡牌翻轉音效
4. WHEN 輻射值變化時 THEN 系統 SHALL 播放蓋革計數器音效，音效強度對應輻射等級
5. WHEN 終端機輸入文字時 THEN 系統 SHALL 播放打字機音效
6. IF 音效檔案載入失敗 THEN 系統 SHALL 記錄錯誤並繼續運作而不中斷使用者體驗
7. WHERE 音效已預載 THE 系統 SHALL 在 100ms 內開始播放音效

### 需求 2：語音合成（Text-to-Speech）
**使用者故事**：作為一個視覺障礙使用者，我希望系統能朗讀塔羅牌解讀內容，讓我也能使用平台

#### 驗收標準

1. WHEN 使用者啟用語音播放功能 THEN 系統 SHALL 使用 Web Speech API 朗讀塔羅牌解讀文字
2. WHEN AI 串流解讀內容時 THEN 系統 SHALL 支援即時語音合成（streaming TTS）
3. IF 使用者選擇特定角色語音（如 Mr. Handy、Brotherhood Scribe）THEN 系統 SHALL 調整語音參數（音調、速度）以匹配角色風格
4. WHEN 語音播放進行中且使用者點擊暫停 THEN 系統 SHALL 立即暫停語音播放
5. WHEN 語音播放進行中且使用者點擊停止 THEN 系統 SHALL 停止語音播放並重置播放位置
6. IF 瀏覽器不支援 Web Speech API THEN 系統 SHALL 顯示友善的錯誤訊息並隱藏語音控制按鈕
7. WHILE 語音播放進行中 THE 系統 SHALL 顯示視覺指示器（波形或脈衝動畫）

### 需求 3：背景音樂管理
**使用者故事**：作為一個廢土旅者，我希望在使用平台時聽到廢土氛圍背景音樂，增強沉浸感

#### 驗收標準

1. WHEN 使用者進入主頁面 THEN 系統 SHALL 播放循環背景音樂（廢土環境音）
2. WHEN 使用者開始進行塔羅占卜 THEN 系統 SHALL 切換至占卜主題背景音樂
3. IF 使用者在設定中關閉背景音樂 THEN 系統 SHALL 停止所有背景音樂播放
4. WHILE 背景音樂播放中 THE 系統 SHALL 支援無縫循環播放（crossfade 淡入淡出）
5. WHEN 背景音樂切換時 THEN 系統 SHALL 在 2 秒內完成淡出舊音樂和淡入新音樂
6. IF 音樂檔案過大（>2MB）THEN 系統 SHALL 使用串流播放而非完整下載

### 需求 4：音量控制系統
**使用者故事**：作為一個平台使用者，我希望能獨立控制音效、音樂和語音的音量，以自訂我的音訊體驗

#### 驗收標準

1. WHEN 使用者在設定頁面 THEN 系統 SHALL 顯示三個獨立的音量滑桿（音效、音樂、語音）
2. WHEN 使用者調整音效音量滑桿 THEN 系統 SHALL 即時調整所有音效（按鈕聲、卡牌聲等）的音量
3. WHEN 使用者調整音樂音量滑桿 THEN 系統 SHALL 即時調整背景音樂的音量
4. WHEN 使用者調整語音音量滑桿 THEN 系統 SHALL 即時調整 TTS 語音的音量
5. IF 使用者將任何音量設為 0 THEN 系統 SHALL 靜音該類別的所有音訊
6. WHEN 使用者調整音量設定 THEN 系統 SHALL 將設定儲存至 localStorage 以便下次訪問時載入
7. IF 系統偵測到音訊輸出裝置變更（如插入耳機）THEN 系統 SHALL 保持當前音量設定

### 需求 5：音效快取和預載
**使用者故事**：作為一個平台使用者，我希望音效能快速播放而不延遲，提供流暢的互動體驗

#### 驗收標準

1. WHEN 應用程式初始化時 THEN 系統 SHALL 預載所有關鍵音效檔案（按鈕聲、卡牌聲、蓋革計數器）
2. WHEN 音效檔案下載完成 THEN 系統 SHALL 將音訊緩衝區快取在記憶體中
3. IF 記憶體使用超過 50MB THEN 系統 SHALL 清除最少使用的非關鍵音效快取
4. WHILE 頁面閒置超過 5 分鐘 THE 系統 SHALL 釋放部分音效快取以節省資源
5. WHEN 使用者首次點擊任何互動元素 THEN 系統 SHALL 解鎖 Web Audio Context（符合瀏覽器自動播放政策）
6. IF 網路連線緩慢（>3 秒載入時間）THEN 系統 SHALL 顯示載入指示器並延遲播放

### 需求 6：行動裝置音訊支援
**使用者故事**：作為一個行動裝置使用者，我希望音效系統在我的手機或平板上正常運作

#### 驗收標準

1. WHEN 使用者在行動裝置上首次互動（觸控任何元素）THEN 系統 SHALL 初始化並解鎖 Web Audio Context
2. IF 裝置處於靜音模式 THEN 系統 SHALL 偵測並在 UI 顯示靜音提示
3. WHEN 使用者切換應用程式（app 進入背景）THEN 系統 SHALL 暫停所有音訊播放
4. WHEN 使用者返回應用程式（app 回到前景）THEN 系統 SHALL 恢復之前的音訊播放狀態
5. IF iOS 裝置使用低電量模式 THEN 系統 SHALL 減少音效複雜度（降低採樣率或減少同時播放數）
6. WHILE 行動裝置電池低於 20% THE 系統 SHALL 自動降低背景音樂音量至 30%

### 需求 7：音訊效果處理
**使用者故事**：作為一個廢土旅者，我希望音效具有 Fallout 特色的處理效果（如無線電雜訊、迴響），增強主題氛圍

#### 驗收標準

1. WHEN 播放角色語音（Mr. Handy、Brotherhood Scribe）THEN 系統 SHALL 套用對應的音訊濾鏡（機械音、無線電效果）
2. WHEN 使用者在 Vault 場景中 THEN 系統 SHALL 對音效套用輕微迴響效果（reverb）
3. WHEN 播放蓋革計數器音效 THEN 系統 SHALL 根據輻射值動態調整音效播放頻率（低輻射：緩慢，高輻射：快速）
4. IF 使用者啟用「經典模式」THEN 系統 SHALL 套用 8-bit 降採樣濾鏡模擬 80 年代音效
5. WHEN 終端機音效播放時 THEN 系統 SHALL 套用類比失真效果（analog distortion）
6. IF Web Audio API 不支援特定濾鏡 THEN 系統 SHALL 降級至基本播放而不套用效果

### 需求 8：錯誤處理和降級策略
**使用者故事**：作為一個平台使用者，即使我的瀏覽器不完全支援 Web Audio API，我仍希望能使用基本功能

#### 驗收標準

1. IF 瀏覽器不支援 Web Audio API THEN 系統 SHALL 降級使用 HTML5 `<audio>` 元素
2. IF 瀏覽器不支援 Web Speech API THEN 系統 SHALL 隱藏語音播放功能但保留其他音效功能
3. WHEN 音訊初始化失敗 THEN 系統 SHALL 記錄詳細錯誤資訊到 logger 並顯示使用者友善的訊息
4. IF 使用者拒絕音訊權限 THEN 系統 SHALL 靜默運作並不再嘗試播放音訊
5. WHEN 音訊檔案 404 或載入失敗 THEN 系統 SHALL 重試最多 3 次，失敗後跳過該音效
6. IF 系統偵測到音訊播放錯誤率超過 30% THEN 系統 SHALL 自動停用音效系統並通知使用者

### 需求 9：效能和資源管理
**使用者故事**：作為一個平台使用者，我希望音效系統不會影響應用程式的整體效能

#### 驗收標準

1. WHILE 應用程式運行中 THE 音效系統 SHALL 使用不超過 50MB 的記憶體
2. WHEN 同時播放多個音效時 THEN 系統 SHALL 限制最大並發播放數為 8 個
3. IF 頁面 FPS 低於 30 THEN 系統 SHALL 自動降低音效品質（降低採樣率或關閉效果處理）
4. WHEN 音效播放完成 THEN 系統 SHALL 在 1 秒內釋放對應的音訊資源
5. IF 偵測到記憶體洩漏（記憶體持續增長）THEN 系統 SHALL 重新初始化 Audio Context
6. WHILE 網頁處於背景分頁 THE 系統 SHALL 暫停所有非關鍵音訊處理

### 需求 10：無障礙和使用者偏好
**使用者故事**：作為一個有特殊需求的使用者，我希望能完全控制音訊功能以符合我的需求

#### 驗收標準

1. WHEN 系統偵測到使用者的作業系統啟用「減少動態效果」偏好 THEN 系統 SHALL 預設停用所有音效
2. IF 使用者啟用鍵盤導航模式 THEN 系統 SHALL 為音量控制提供鍵盤快捷鍵（上下箭頭調整，M 靜音）
3. WHEN 音訊播放時 THEN 系統 SHALL 提供視覺替代方案（如音效播放時的圖示動畫）
4. IF 使用者使用螢幕閱讀器 THEN 系統 SHALL 提供 ARIA 標籤說明當前音訊狀態
5. WHEN 使用者首次訪問網站 THEN 系統 SHALL 顯示音訊權限說明和設定引導
6. IF 使用者在設定中選擇「完全靜音模式」THEN 系統 SHALL 停用所有音訊功能並移除相關 UI 元素

## 非功能性需求

### 效能需求
- 音效播放延遲：<100ms（從觸發到開始播放）
- 音效檔案載入時間：<2 秒（關鍵音效）
- 記憶體使用：<50MB（所有音效快取）
- CPU 使用：<5%（閒置時），<15%（播放時）

### 相容性需求
- **支援瀏覽器**：Chrome 90+、Firefox 88+、Safari 14+、Edge 90+
- **行動裝置**：iOS 14+、Android 10+
- **降級支援**：IE11 和舊版瀏覽器使用 HTML5 Audio

### 安全性需求
- 所有音訊檔案透過 HTTPS 傳輸
- 遵守瀏覽器自動播放政策（需使用者互動）
- 不收集音訊使用資料（符合隱私政策）

### 可維護性需求
- 音效檔案集中管理（單一設定檔）
- 支援熱更新音效資源（無需重新部署）
- 提供詳細的錯誤日誌和監控

---

*文件版本*：1.0
*建立日期*：2025-10-01
*語言*：繁體中文（zh-TW）
