# Chirp 3:HD 回滾程序

## 概述

本文檔說明在 Chirp 3:HD 滾動推出過程中出現問題時的回滾程序。

**緊急回滾時間目標**: < 1 分鐘

---

## 回滾觸發條件

### 立即回滾（P0）

在以下情況下，**立即執行回滾**：

1. **錯誤率 > 10%**
   - 合成失敗率超過 10%
   - API 端點錯誤率 > 10%

2. **效能嚴重下降**
   - 平均合成時間 > 5 秒
   - P95 合成時間 > 10 秒

3. **Fallback 率異常**
   - Fallback 到 WaveNet 的比率 > 20%

4. **系統穩定性問題**
   - 服務不可用
   - 資料庫連線問題
   - 記憶體/CPU 使用率異常

5. **使用者影響**
   - 大量使用者投訴
   - 業務關鍵功能受影響

### 逐步回滾（P1）

在以下情況下，考慮**逐步回滾**：

1. **錯誤率 5-10%**
   - 合成失敗率 5-10%
   - 特定角色出現問題

2. **效能輕微下降**
   - 平均合成時間 2-5 秒
   - P95 合成時間 5-10 秒

3. **Fallback 率略高**
   - Fallback 率 5-20%

4. **品質問題**
   - 語音品質不符合預期
   - 特定角色語音不匹配

---

## 回滾步驟

### 步驟 1: 立即停用 Chirp 3:HD

**方法 1: 環境變數更新（推薦）**

```bash
# 更新環境變數
export CHIRP3_ENABLED=false

# 或通過部署平台更新環境變數
# Zeabur / Vercel / Railway 等平台 UI
```

**方法 2: 快速回滾到前一版本**

```bash
# 如果使用 Git 部署
git revert <commit-hash>
git push origin main
```

### 步驟 2: 重啟服務

```bash
# 根據部署平台重啟服務
# Zeabur: 自動重啟（環境變數更新後）
# Docker: docker-compose restart backend
# Systemd: sudo systemctl restart wasteland-tarot-backend
```

### 步驟 3: 驗證回滾成功

```bash
# 執行驗證腳本
cd backend
python scripts/verify_deployment.py --exit-on-error

# 或手動檢查
curl http://your-api-url/api/v1/monitoring/health
curl http://your-api-url/api/v1/audio/synthesize \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{"text": "test", "character_key": "pip_boy"}'
```

### 步驟 4: 監控恢復

```bash
# 啟動監控腳本確認系統恢復正常
python scripts/monitor_chirp3_rollout.py --watch
```

### 步驟 5: 通知團隊

立即通知：
- **技術負責人**
- **DevOps 團隊**
- **產品經理**

通知內容：
- 回滾原因
- 影響範圍
- 恢復狀態
- 下一步行動

---

## 角色特定回滾

如果只有特定角色出現問題，可以僅回滾該角色：

```bash
# 從啟用列表中移除問題角色
# 例如：移除 pip_boy
CHIRP3_ENABLED_CHARACTERS="vault_dweller,wasteland_trader"

# 或完全停用該角色
CHIRP3_ENABLED_CHARACTERS="vault_dweller,wasteland_trader"
# （不包含問題角色）
```

---

## 百分比回滾

如果問題較輕微，可以降低滾動百分比：

```bash
# 從 50% 降到 10%
CHIRP3_ROLLOUT_PERCENTAGE=10

# 或完全停用
CHIRP3_ROLLOUT_PERCENTAGE=0
```

---

## 回滾後行動

### 立即行動（< 1 小時）

1. ✅ 確認系統恢復正常
2. ✅ 收集錯誤日誌
3. ✅ 分析問題原因
4. ✅ 記錄回滾時間和原因

### 短期行動（< 24 小時）

1. ✅ 深入分析問題根因
2. ✅ 修復識別的問題
3. ✅ 更新測試套件
4. ✅ 準備修復後的重新部署計劃

### 長期行動（< 1 週）

1. ✅ 撰寫事故報告（Post-Mortem）
2. ✅ 改進監控和告警
3. ✅ 更新回滾程序（如果發現問題）
4. ✅ 重新計劃滾動推出

---

## 回滾檢查清單

### 回滾前

- [ ] 確認回滾觸發條件
- [ ] 通知相關團隊成員
- [ ] 準備回滾步驟
- [ ] 確認有權限執行回滾

### 回滾執行

- [ ] 更新環境變數
- [ ] 重啟服務
- [ ] 驗證回滾成功
- [ ] 確認系統恢復正常

### 回滾後

- [ ] 監控系統狀態 24 小時
- [ ] 收集錯誤日誌
- [ ] 分析問題根因
- [ ] 通知團隊回滾完成
- [ ] 記錄回滾記錄

---

## 回滾記錄模板

```markdown
## 回滾記錄

**日期時間**: 2025-11-04 14:30 UTC
**回滾執行者**: [姓名]
**回滾原因**: [原因]
**觸發條件**: [P0/P1]

### 回滾前狀態
- Chirp 3:HD 啟用狀態: [enabled/disabled]
- 滾動百分比: [X%]
- 啟用角色: [角色列表]

### 回滾執行
- 回滾方法: [環境變數/版本回滾]
- 回滾時間: [X 分鐘]
- 影響範圍: [受影響的使用者/請求數]

### 回滾後狀態
- 系統狀態: [正常/異常]
- 錯誤率: [X%]
- 效能指標: [平均時間 Xs]

### 問題分析
- 根本原因: [分析]
- 修復計劃: [計劃]

### 後續行動
- [ ] 修復問題
- [ ] 更新測試
- [ ] 重新部署計劃
```

---

## 常見問題

### Q: 回滾需要多長時間？

**A**: 目標是 < 1 分鐘。通常環境變數更新 + 服務重啟在 30-60 秒內完成。

### Q: 回滾會影響現有使用者嗎？

**A**: 回滾過程中可能有短暫的服務中斷（< 10 秒）。回滾後，所有請求會立即使用 WaveNet，確保穩定性。

### Q: 如何驗證回滾成功？

**A**:
1. 檢查健康端點
2. 執行 TTS 合成測試
3. 確認所有請求使用 WaveNet
4. 檢查 metrics 確認無 Chirp 3:HD 請求

### Q: 回滾後如何重新啟用？

**A**: 修復問題後，按照滾動推出計劃重新逐步啟用：
1. 10% → 監控 24 小時
2. 50% → 監控 48 小時
3. 100% → 監控 1 週

---

## 緊急聯絡

- **技術負責人**: [填寫]
- **DevOps 團隊**: [填寫]
- **產品經理**: [填寫]
- **緊急聯絡方式**: [填寫]

---

**最後更新**: 2025-11-04
