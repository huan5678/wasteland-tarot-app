'use client';

import React, { useState, useEffect } from 'react';
import { animated, useSpring } from '@react-spring/web';
import { PixelIcon } from '@/components/ui/icons';
import type { IconName } from '@/components/ui/icons';
import { usePlatform } from '@/hooks/usePlatform';
import { useSafeArea } from '@/hooks/useSafeArea';
import { Button } from "@/components/ui/button";
import { cn } from '@/lib/utils';

interface NavigationItem {
  id: string;
  label: string;
  iconName: IconName;
  href: string;
  isActive?: boolean;
  badge?: number;
}

interface MobileNavigationProps {
  currentPath?: string;
  onNavigate?: (path: string) => void;
  className?: string;
}

const navigationItems: NavigationItem[] = [
  { id: 'home', label: '首頁', iconName: 'home', href: '/' },
  { id: 'cards', label: '卡牌', iconName: 'cards', href: '/cards' },
  { id: 'readings', label: '占卜', iconName: 'book-open', href: '/readings' },
  { id: 'achievements', label: '成就', iconName: 'trophy', href: '/achievements' },
  { id: 'profile', label: '個人', iconName: 'user', href: '/profile' }
];




export function MobileNavigation({
  currentPath = '/',
  onNavigate,
  className = ''
}: MobileNavigationProps) {
  const [lastScrollY, setLastScrollY] = useState(0);
  const [isVisible, setIsVisible] = useState(true);

  const platform = usePlatform();
  const safeArea = useSafeArea();
  const isIOS = platform === 'ios';
  const isAndroid = platform === 'android';

  // Auto-hide navigation on scroll (disabled for now - always visible per spec)
  useEffect(() => {
    const handleScroll = () => {
      const currentScrollY = window.scrollY;

      // Only hide on significant downward scroll
      if (currentScrollY > lastScrollY && currentScrollY > 100) {
        setIsVisible(false);
      } else {
        setIsVisible(true);
      }

      setLastScrollY(currentScrollY);
    };

    window.addEventListener('scroll', handleScroll, { passive: true });
    return () => window.removeEventListener('scroll', handleScroll);
  }, [lastScrollY]);

  // Animation spring for hide/show
  const navSpring = useSpring({
    transform: isVisible ? 'translateY(0%)' : 'translateY(100%)',
    opacity: isVisible ? 1 : 0,
    config: { tension: 300, friction: 30 }
  });

  const handleNavigation = (path: string) => {
    if (onNavigate) {
      onNavigate(path);
    }
    
    // If already on the page, scroll to top
    if (currentPath === path) {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };

  return (
    <>
      {/* Quick Actions Floating Panel */}
      {quickActionsTransition((style, item) =>
      item ?
      <animated.div
        style={style}
        className="fixed bottom-24 right-4 z-40">

            <div className="bg-black/90 backdrop-blur-sm border border-pip-boy-green/30 rounded-2xl p-3 shadow-xl">
              <div className="grid grid-cols-2 gap-3">
                {quickActions.map((action) =>
            <Button size="icon" variant="link"
            key={action.id}
            onClick={() => handleQuickAction(action.action)}
            className="flex flex-col items-center gap-1 p-3 transition-colors">

                    <PixelIcon name={action.iconName as any} size={16} decorative />
                    <span className="text-xs">{action.label}</span>
                  </Button>
            )}
              </div>
            </div>
          </animated.div> :
      null
      )}

      {/* Main Navigation Bar */}
      <animated.nav
        style={navSpring}
        className={`
          fixed bottom-0 left-0 right-0 z-30
          bg-black/95 backdrop-blur-sm border-t border-pip-boy-green/30
          ${isIOS ? 'pb-safe' : 'pb-4'}
          ${className}
        `}>

        {/* Expanded Menu */}
        <animated.div
          style={expandSpring}
          className="overflow-hidden">

          <div className="px-4 py-3 border-b border-pip-boy-green/20">
            <div className="grid grid-cols-4 gap-3">
              {quickActions.map((action) =>
              <Button size="icon" variant="link"
              key={action.id}
              onClick={() => handleQuickAction(action.action)}
              className="flex flex-col items-center gap-2 p-3 transition-colors">

                  <PixelIcon name={action.iconName as any} size={16} decorative />
                  <span className="text-xs">{action.label}</span>
                </Button>
              )}
            </div>
          </div>
        </animated.div>

        {/* Main Navigation Items */}
        <div className="flex items-center justify-between px-4 py-2">
          {navigationItems.map((item) => {
            const isActive = currentPath === item.href ||
            item.href !== '/' && currentPath.startsWith(item.href);

            return (
              <Button size="icon" variant="default"
              key={item.id}
              onClick={() => handleNavigation(item.href)}
              className="{expression}">







                <div className="relative">
                  <PixelIcon name={item.iconName as any} size={24} decorative />
                  {item.badge &&
                  <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                      {item.badge > 99 ? '99+' : item.badge}
                    </span>
                  }
                  {isActive &&
                  <div className="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-1 h-1 bg-pip-boy-green rounded-full animate-pulse" />
                  }
                </div>
                <span className={`text-xs ${isActive ? 'font-bold' : ''}`}>
                  {item.label}
                </span>
              </Button>);

          })}

          {/* Expand/Collapse Button */}
          <Button size="default" variant="default"
          onClick={() => {
            setIsExpanded(!isExpanded);
            setShowQuickActions(false);
          }}
          className="{expression}">







            <PixelIcon name="chevron-up" size={24} className={`transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`} decorative />
            <span className="text-xs">更多</span>
          </Button>
        </div>

        {/* Floating Action Button */}
        <Button size="icon" variant="default"
        onClick={() => setShowQuickActions(!showQuickActions)}
        className="{expression}"






        aria-label="快速操作">

          <PixelIcon name="star" size={24} decorative />
        </Button>

        {/* Safe area padding for iOS */}
        {isIOS && <div className="h-safe-area-inset-bottom" />}
      </animated.nav>
    </>);

}

// Tab Bar component for simpler navigation needs
interface MobileTabBarProps {
  tabs: Array<{
    id: string;
    label: string;
    iconName: IconName;
    isActive?: boolean;
    badge?: number;
  }>;
  onTabChange?: (tabId: string) => void;
  className?: string;
}

export function MobileTabBar({
  tabs,
  onTabChange,
  className = ''
}: MobileTabBarProps) {
  const { isIOS } = useAdvancedDeviceCapabilities();

  return (
    <div className={`
      bg-black/90 backdrop-blur-sm border-t border-pip-boy-green/30
      ${isIOS ? 'pb-safe' : 'pb-2'}
      ${className}
    `}>
      <div className="flex items-center justify-around py-2">
        {tabs.map((tab) =>
        <Button size="icon" variant="default"
        key={tab.id}
        onClick={() => onTabChange?.(tab.id)}
        className="{expression}">







            <div className="relative">
              <PixelIcon name={tab.iconName as any} size={24} decorative />
              {tab.badge &&
            <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                  {tab.badge > 99 ? '99+' : tab.badge}
                </span>
            }
            </div>
            <span className={`text-xs ${tab.isActive ? 'font-bold' : ''}`}>
              {tab.label}
            </span>
          </Button>
        )}
      </div>
    </div>);

}

// Pull-to-refresh component
interface PullToRefreshProps {
  onRefresh: () => Promise<void>;
  children: React.ReactNode;
  threshold?: number;
  className?: string;
}

export function PullToRefresh({
  onRefresh,
  children,
  threshold = 60,
  className = ''
}: PullToRefreshProps) {
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [pullDistance, setPullDistance] = useState(0);
  const [startY, setStartY] = useState(0);

  const refreshSpring = useSpring({
    transform: `translateY(${Math.min(pullDistance, threshold)}px)`,
    opacity: pullDistance > 0 ? Math.min(pullDistance / threshold, 1) : 0,
    config: { tension: 300, friction: 30 }
  });

  const handleTouchStart = (e: React.TouchEvent) => {
    if (window.scrollY === 0) {
      setStartY(e.touches[0].clientY);
    }
  };

  const handleTouchMove = (e: React.TouchEvent) => {
    if (startY === 0 || window.scrollY > 0) return;

    const currentY = e.touches[0].clientY;
    const distance = Math.max(0, currentY - startY);
    setPullDistance(distance);
  };

  const handleTouchEnd = async () => {
    if (pullDistance >= threshold && !isRefreshing) {
      setIsRefreshing(true);
      try {
        await onRefresh();
      } finally {
        setIsRefreshing(false);
      }
    }
    setPullDistance(0);
    setStartY(0);
  };

  return (
    <div
      className={className}
      onTouchStart={handleTouchStart}
      onTouchMove={handleTouchMove}
      onTouchEnd={handleTouchEnd}>

      {/* Refresh Indicator */}
      <animated.div
        style={refreshSpring}
        className="fixed top-0 left-0 right-0 z-40 bg-pip-boy-green/20 backdrop-blur-sm">

        <div className="flex items-center justify-center p-4">
          <div className={`
            w-8 h-8 border-2 border-pip-boy-green rounded-full
            ${isRefreshing ? 'animate-spin border-t-transparent' : ''}
          `} />
          <span className="ml-2 text-pip-boy-green text-sm">
            {isRefreshing ? '正在更新...' : pullDistance >= threshold ? '釋放以更新' : '下拉更新'}
          </span>
        </div>
      </animated.div>

      {children}
    </div>);

}